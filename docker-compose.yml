version: "3.9"

services:
  # ------------------- Traefik (Reverse Proxy) -------------------
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: always
    command:
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      - "--certificatesresolvers.mytlschallenge.acme.email=${SSL_EMAIL}"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
    ports:
      - "0.0.0.0:80:80"
      - "0.0.0.0:443:443"
    volumes:
      - traefik_data:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - frontend
      - internal

  # Main app → https://self.plumoai.com (DOMAIN_NAME) — low priority so /api/* goes to auth/company
  main-app:
    image: plumoai/plumoai-app:${MAIN_VERSION}
    container_name: main-app
    restart: unless-stopped
    networks:
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.main.rule=Host(`${DOMAIN_NAME}`)"
      - "traefik.http.routers.main.entrypoints=websecure"
      - "traefik.http.routers.main.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.main.priority=1"
      - "traefik.http.services.main.loadbalancer.server.port=80"

  # Auth API → https://self.plumoai.com/api/auth (priority so path wins over main)
  # internal = reach MySQL (hostname "mysql"); frontend = outbound internet (e.g. api.plumoai.com)
  # Secrets are mounted read-only at /run/secrets/<name>.
  auth:
    image: plumoai/authservice:${AUTH_VERSION}
    container_name: auth-service
    restart: unless-stopped
    networks:
      - frontend
      - internal
    environment:
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
    secrets:
      - mysql_db
      - mysql_user
      - mysql_password
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=Host(`${DOMAIN_NAME}`) && PathPrefix(`/api/auth`)"
      - "traefik.http.routers.auth.entrypoints=websecure"
      - "traefik.http.routers.auth.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.auth.priority=200"
      - "traefik.http.routers.auth.service=auth"
      - "traefik.http.services.auth.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.auth-strip.stripprefix.prefixes=/api/auth"
      - "traefik.http.routers.auth.middlewares=auth-strip"

  # ------------------- Company Service -------------------
  company:
    image: plumoai/api-service:${API_VERSION}
    container_name: api-service
    restart: unless-stopped
    networks:
      - frontend
      - internal
    environment:
      PORT: ${PORT:-3001}
      DB_HOST: ${DB_HOST:-mysql}
      DB_PORT: ${DB_PORT:-3306}
      MONGODB_HOST: ${MONGODB_HOST:-mongodb}
      MONGODB_PORT: ${MONGODB_PORT:-27017}
      # Internal call to auth (no Traefik, no /api/auth prefix — auth listens on :3000 at /)
      Auth_URL: ${Auth_URL:-http://auth:3000}
    secrets:
      - mysql_db
      - mysql_user
      - mysql_password
      - mongo_db
      - mongo_user
      - mongo_password
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`${DOMAIN_NAME}`) && PathPrefix(`/api/company`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.api.priority=100"
      - "traefik.http.services.api.loadbalancer.server.port=3001"
      - "traefik.http.middlewares.api-strip.stripprefix.prefixes=/api/company"
      - "traefik.http.routers.api.middlewares=api-strip"

  # ------------------- AI Service (internal only — no exposed URL) -------------------
  # Other services call it by hostname: http://ai:<port> (e.g. http://ai:3000)
  ai:
    image: plumoai/ai-service:${AI_VERSION}
    container_name: ai-service
    restart: unless-stopped
    networks:
      - internal
    # No Traefik labels — not exposed to the internet

  # ------------------- MySQL Database -------------------
  mysql:
    image: mysql:8.0
    container_name: plumoai-mysql
    restart: unless-stopped
    command:
      - --default-authentication-plugin=mysql_native_password
      - --log-bin-trust-function-creators=1
      - --lower_case_table_names=1
    environment:
      MYSQL_DATABASE_FILE: /run/secrets/mysql_db
      MYSQL_USER_FILE: /run/secrets/mysql_user
      MYSQL_PASSWORD_FILE: /run/secrets/mysql_password
      MYSQL_ROOT_PASSWORD: /run/secrets/mysql_password
    secrets:
      - mysql_db
      - mysql_user
      - mysql_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init-privileges.sql:/docker-entrypoint-initdb.d/01-init-privileges.sql:ro
    networks:
      - internal

  # ------------------- MongoDB (own secrets: mongo_db, mongo_user, mongo_password) -------------------
  mongodb:
    image: mongo:7
    container_name: plumoai-mongodb
    restart: unless-stopped
    entrypoint: ["/scripts/mongo-secrets-entrypoint.sh"]
    volumes:
      - ./scripts/mongo-secrets-entrypoint.sh:/scripts/mongo-secrets-entrypoint.sh:ro
      - mongo_data:/data/db
    secrets:
      - mongo_db
      - mongo_user
      - mongo_password
    networks:
      - internal

# ------------------- Networks -------------------
# frontend: normal network so Traefik gets host port bindings (80, 443)
# internal: isolated (no outbound); backends + Traefik for backend access
networks:
  frontend:
  internal:
    internal: true

# ------------------- Volumes -------------------
volumes:
  traefik_data:
  mysql_data:
  mongo_data:

# ------------------- Secrets -------------------
secrets:
  mysql_db:
    file: ./secrets/mysql_db.txt
  mysql_user:
    file: ./secrets/mysql_user.txt
  mysql_password:
    file: ./secrets/mysql_password.txt
  mongo_db:
    file: ./secrets/mongo_db.txt
  mongo_user:
    file: ./secrets/mongo_user.txt
  mongo_password:
    file: ./secrets/mongo_password.txt
